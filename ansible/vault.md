# Ansible vault

When configuring an environment, you often need to get sensitive information (eg: passwords, api keys, private keys, ...) onto the systems. You do not want to expose these values by accident by pushing to a public git repository by accident.

An easy solution for this problem is to use `ansible-vault`. This command allows you to encrypt / decrypt files on-the-fly. You would then store the encrypted value inside your repository

## Encryption

To encrypt a specific file, simply run:

```bash
$ echo blah > secret-stuff

$ cat secret-stuff
blah

$ ansible-vault encrypt secret-stuff
New Vault password:
Confirm New Vault password:
Encryption successful

$ cat secret-stuff
$ANSIBLE_VAULT;1.1;AES256
64643661366466346333343064316236653331366634336563343734346238663135313732363634
3734623731316630373336656636306235316636383330620a323264336437653938646632393232
36353036313535613130613164356461646264383763333534623036633233653334656634653837
3139656266333235640a396364353966396235396163633364336235623139633266376230653938
3833
```

As you can see, the content of the file `secret-stuff` has now been encrypted by ansible-vault and can be safely checked into git. You need the passphrase you used to encrypt the file to actually read its content


## Decryption

To decrypt a specific file, simply run:

```bash
$ cat secret-stuff
$ANSIBLE_VAULT;1.1;AES256
64643661366466346333343064316236653331366634336563343734346238663135313732363634
3734623731316630373336656636306235316636383330620a323264336437653938646632393232
36353036313535613130613164356461646264383763333534623036633233653334656634653837
3139656266333235640a396364353966396235396163633364336235623139633266376230653938
3833

$ ansible-vault decrypt secret-stuff
Vault password:
Decryption successful

$ cat secret-stuff
blah
```

As you can see, the file has now been decrypted again


## Ansible integration

Having to specify a password is not very handy when trying to fully automate configuration / orchestration. Luckily there is an option you can set in your `ansible.cfg` file to tell `ansible-vault` where to look for the passphrase inside a file. This file should be put in your `.gitignore` file and the secret should be rotated regularly.

```ini
[defaults]
vault_identity_list = .vault-password
``` 

This configuration tells `ansible-vault` to look for a file called `.vault-password` inside the current directory to read the passphrase from

```bash
$ ansible-vault encrypt secret-stuff
Encryption successful

$ ansible-vault decrypt secret-stuff
Decryption successful
```

As you can see, we are not prompted for the password anymore. Even more, if you use this setup, `ansible` and `ansible-playbook` will be able to decrypt encrypted files on-the-fly, so you only need to decrypt them to change or add things to them

Also, the `copy` directive will take an encrypted file and put the unencrypted version of it on the target machine


## Git hook

I wrote a small git pre-commit hook script to ensure we never accidentally check-in sensitive files

```bash
#!/bin/bash

shopt -s nullglob

STAGED_FILES=( $(git diff --cached --name-only | grep 'vault\|\.jks\|\.pem$' ) )

for FILE in "${STAGED_FILES[@]}"; do
	if [ -e $FILE ]; then
		if ! grep -q 'ANSIBLE_VAULT;1.1;AES256' "$FILE"; then
			echo "Vault file '$FILE' is not encrypted! Please encrypt using 'ansible-vault encrypt $FILE' before commit!"
			exit 1
		fi
	fi
done
```

This will check that all staged files ending with `vault`, `.jks` or `.pem` start with the `ANSIBLE_VAULT` header generated by the `ansible-vault encrypt` command. If not, it will abort the commit

To activate the script, simply put it in `.git/hooks/pre-commit` and by magic, git will not allow you to push plain-text secrets to your git repository anymore


## Usage

I have found it useful to put all our secrets into a file named `vault` and prefix all variables with `vault_` inside this file (eg: `group_vars/all/vault`).

```yaml
vault_db_password = Thaoti7etaiWai0ohshahj7xau3akei0
vault_rabbitmq_password = saenia0Eeziiz3ief2oeCiecealei9ee
vault_api_key = teij6eej1hie6eite8Mi0Ooth2echooz
```

and then simply use these values inside playbooks, roles, or other group_vars files:

```yaml
spring.datasource.url= jdbc:postgresql://db.{{ fqdn_internal }}:5432/some_db?ApplicationName={{ application }}
spring.datasource.username = some_user
spring.datasource.password = {{ vault_db_password }}

```

## Rotating vault password

Since all files are encrypted using the same password from `.vault-password`, this password should be rotated regularly. Rotating means re-encrypting all encrypted files with a new password

  * decrypt all encrypted files using the old password
  * encrypt all sensitive files using the new password

You can find all encrypted files by grepping for the `ansible-vault` header `ANSIBLE_VAULT;1.1;AES256` and then simply running `ansible-vault decrypt` on all of them.

A quick and dirty script to rotate your vault password would look something like the following (please backup your existing password before running the script since it will overwrite it)

```bash
#!/bin/bash

set -eo pipefail

[[ -e .vault-password.old ]] && { echo "Found existing backup file '.vault-password.old'. Previous run probably failed. Exiting."; exit 1; }

SENSITIVE_FILES=( $(find /your/ansible/dir -type f -name "vault" -o -name "*.jks" -o -name "*.pem") )

mv .vault-password .vault-password.old
pwgen -ys 32 1 > .vault-password
ansible-vault rekey --vault-password-file=.vault-password.old --new-vault-password-file=.vault-password "${SENSITIVE_FILES[@]}"
rm .vault-password.old
```